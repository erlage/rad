// framework stop propagation of '__EventNativeName__' events 
// when they reachs a matching target(that is listening for those type of 
// events). to test capturing for __EventNativeName__ events, we artifically 
// restart propagation using restartPropagationIfStopped()

test('should capture event', () async {
  var pap = app!;

  await pap.buildChildren(
    widgets: [
      RT_EventfulWidget(
          key: GlobalKey('el-g-parent'),
          __EventAttributeName__: (event) {
            pap.stack.push('__EventNativeName__-g-parent');

            event.restartPropagationIfStopped();
          },
          children: [
          RT_EventfulWidget(
            key: GlobalKey('el-parent'),
            __EventAttributeName__Capture: (event) {
              pap.stack.push('__EventNativeName__-parent');

              event.stopPropagation();
            },
            children: [
              RT_EventfulWidget(
                key: GlobalKey('el-child'),
                __EventAttributeName__: (event) {
                  pap.stack.push('__EventNativeName__-child');

                  event.restartPropagationIfStopped();
                },
              ),
            ],
          ),
        ],
      ),
    ],
    parentContext: pap.appContext,
  );

  var gparent = pap.domNodeByGlobalKey('el-g-parent');
  var parent = pap.domNodeByGlobalKey('el-parent');
  var child = pap.domNodeByGlobalKey('el-child');

  gparent.dispatchEvent(Event('__EventNativeName__')); // first
  parent.dispatchEvent(Event('__EventNativeName__'));  // second
  child.dispatchEvent(Event('__EventNativeName__'));   // third
  await Future.delayed(Duration(milliseconds: 50));

  // after 1st dispatch

  expect(pap.stack.popFromStart(), equals('__EventNativeName__-g-parent'));

  // after 2nd dispatch

  expect(pap.stack.popFromStart(), equals('__EventNativeName__-parent'));

  // after 3rd dispatch

  expect(pap.stack.popFromStart(), equals('__EventNativeName__-parent'));

  expect(pap.stack.canPop(), equals(false));
}__Skip__);

test('should capture event(with multiple capture listeners)', () async {
  var pap = app!;

  await pap.buildChildren(
    widgets: [
      RT_EventfulWidget(
          key: GlobalKey('el-g-parent'),
          __EventAttributeName__Capture: (event) {
            pap.stack.push('__EventNativeName__-g-parent');

            event.restartPropagationIfStopped();
          },
          children: [
          RT_EventfulWidget(
            key: GlobalKey('el-parent'),
            __EventAttributeName__Capture: (event) {
              pap.stack.push('__EventNativeName__-parent');

              event.stopPropagation();
            },
            children: [
              RT_EventfulWidget(
                key: GlobalKey('el-child'),
                __EventAttributeName__: (event) {
                  pap.stack.push('__EventNativeName__-child');

                  event.restartPropagationIfStopped();
                },
              ),
            ],
          ),
        ],
      ),
    ],
    parentContext: pap.appContext,
  );

  var gparent = pap.domNodeByGlobalKey('el-g-parent');
  var parent = pap.domNodeByGlobalKey('el-parent');
  var child = pap.domNodeByGlobalKey('el-child');

  gparent.dispatchEvent(Event('__EventNativeName__')); // first
  parent.dispatchEvent(Event('__EventNativeName__'));  // second
  child.dispatchEvent(Event('__EventNativeName__'));   // third
  await Future.delayed(Duration(milliseconds: 50));

  // after 1st dispatch

  expect(pap.stack.popFromStart(), equals('__EventNativeName__-g-parent'));

  // after 2nd dispatch

  expect(pap.stack.popFromStart(), equals('__EventNativeName__-g-parent'));
  expect(pap.stack.popFromStart(), equals('__EventNativeName__-parent'));

  // after 3rd dispatch

  expect(pap.stack.popFromStart(), equals('__EventNativeName__-g-parent'));
  expect(pap.stack.popFromStart(), equals('__EventNativeName__-parent'));

  expect(pap.stack.canPop(), equals(false));
}__Skip__);